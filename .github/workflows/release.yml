name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

permissions:
  contents: write

env:
  GIT_CLIFF_VERSION: "2.7.0"

jobs:
  # =============================================================================
  # VALIDATION - Run validation checks on release tags
  # =============================================================================
  validate-opentofu:
    name: OpenTofu Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "1.11.0"

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: .terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('**/*.tf') }}

      - name: OpenTofu Init
        run: tofu init -backend=false

      - name: OpenTofu Validate
        run: tofu validate

      - name: OpenTofu Format Check
        run: tofu fmt -check -recursive

  validate-tflint:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: "v0.56.0"

      - name: TFLint Init
        run: tflint --init

      - name: TFLint
        run: tflint --recursive

  # =============================================================================
  # CHANGELOG VERIFICATION - Warn if CHANGELOG is outdated
  # =============================================================================
  verify-changelog:
    name: Verify CHANGELOG
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        run: |
          curl -sSfL https://github.com/orhun/git-cliff/releases/download/v${GIT_CLIFF_VERSION}/git-cliff-${GIT_CLIFF_VERSION}-x86_64-unknown-linux-gnu.tar.gz \
            | tar -xz -C /usr/local/bin --strip-components=1 git-cliff-${GIT_CLIFF_VERSION}/git-cliff

      - name: Verify CHANGELOG is up to date
        run: |
          echo "Verifying CHANGELOG.md is up to date..."
          git-cliff --config .cliff.toml --output CHANGELOG.generated.md
          if ! diff -q CHANGELOG.md CHANGELOG.generated.md > /dev/null 2>&1; then
            echo "::warning::CHANGELOG.md may be outdated. Run 'git-cliff --output CHANGELOG.md' to update it"
            diff CHANGELOG.md CHANGELOG.generated.md || true
          else
            echo "âœ… CHANGELOG.md is up to date"
          fi
        continue-on-error: true  # Don't block release, just warn

  # =============================================================================
  # CREATE RELEASE - Generate release with changelog
  # =============================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate-opentofu, validate-tflint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        run: |
          curl -sSfL https://github.com/orhun/git-cliff/releases/download/v${GIT_CLIFF_VERSION}/git-cliff-${GIT_CLIFF_VERSION}-x86_64-unknown-linux-gnu.tar.gz \
            | tar -xz -C /usr/local/bin --strip-components=1 git-cliff-${GIT_CLIFF_VERSION}/git-cliff

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Creating release for version $VERSION"

      - name: Generate release notes
        run: |
          git-cliff --config .cliff.toml --latest --strip header > RELEASE_NOTES.md
          echo "--- Release Notes ---"
          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ github.ref_name }}"
          body_path: RELEASE_NOTES.md
          generate_release_notes: false
          files: |
            CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
